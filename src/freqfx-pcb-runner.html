<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>FREQ-FX: PCB Runner</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0a00;display:flex;align-items:center;justify-content:center;font-family:monospace;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
canvas{image-rendering:pixelated;image-rendering:crisp-edges;display:block}
.mobile-btn{display:none;position:fixed;z-index:10;touch-action:manipulation;border:none;font:bold 11px monospace;border-radius:6px;opacity:0.7}
</style>
</head>
<body>
<canvas id="c"></canvas>
<!-- Mobile controls injected dynamically -->
<script>
(function(){
"use strict";

var W=240,H=160;
var GROUND_Y=130; // ground surface Y
var GRAVITY=600;
var JUMP_VEL=-210;
var MOVE_ACCEL=400;
var MOVE_DECEL=500;
var MAX_RUN=120;
var COYOTE_MS=100;
var JUMP_BUFFER_MS=100;
var DASH_SPEED=220;
var DASH_DURATION=0.35;
var DASH_COOLDOWN=2.0;
var MAX_LIVES=3;
var INVULN_TIME=1.5;
var BASE_SCROLL=50;
var MAX_SCROLL=130;
var SCROLL_RAMP=0.4;
var SPAWN_BASE=1.6;
var SPAWN_MIN=0.5;
var SPAWN_RAMP=0.006;
var PICKUP_CHANCE=0.35;
var PLAYER_W=12,PLAYER_H=16;

// Desert palette
var C_SKY_TOP="#1a0533";
var C_SKY_BOT="#cc6622";
var C_SUN="#ffdd44";
var C_SUN_GLOW="rgba(255,200,60,0.3)";
var C_DUNE_FAR="#884422";
var C_DUNE_MID="#995533";
var C_DUNE_NEAR="#aa6633";
var C_GROUND="#cc8844";
var C_GROUND_DARK="#aa6633";
var C_GROUND_LINE="#bb7733";
var C_SAND_SPEC="#ddaa66";
var C_ROBOT_BODY="#3366aa";
var C_ROBOT_DARK="#224488";
var C_ROBOT_LIGHT="#5588cc";
var C_VISOR="#ff44aa";
var C_VISOR_HI="#ff88cc";
var C_HAZARD="#ff3333";
var C_HAZARD_GLOW="#ff6644";
var C_SPARK="#ffff88";
var C_PICKUP="#44ffcc";
var C_PICKUP_GLOW="#88ffee";
var C_TEXT="#ffcc44";
var C_TEXT_DIM="#886633";
var C_HEART="#ff4466";
var C_DASH_READY="#44ffcc";
var C_DASH_COOL="#554433";
var C_HUD_BG="rgba(0,0,0,0.55)";

var canvas=document.getElementById("c");
var ctx=canvas.getContext("2d");
canvas.width=W;canvas.height=H;

var isMobile="ontouchstart"in window||navigator.maxTouchPoints>0;

// Mobile buttons
var mobileButtons=[];
if(isMobile){
  var bdef=[
    {id:"ml",text:"\u25C0",x:"16px",bottom:"24px",w:44,h:44},
    {id:"mr",text:"\u25B6",x:"68px",bottom:"24px",w:44,h:44},
    {id:"mj",text:"JUMP",right:"16px",bottom:"74px",w:56,h:44},
    {id:"md",text:"DASH",right:"16px",bottom:"24px",w:56,h:40}
  ];
  bdef.forEach(function(d){
    var b=document.createElement("button");
    b.className="mobile-btn";
    b.textContent=d.text;
    b.style.display="block";
    b.style.width=d.w+"px";b.style.height=d.h+"px";
    if(d.x) b.style.left=d.x;
    if(d.right) b.style.right=d.right;
    b.style.bottom=d.bottom;
    b.style.background="rgba(255,200,100,0.2)";
    b.style.color="#ffcc66";
    b.style.border="1px solid rgba(255,200,100,0.4)";
    document.body.appendChild(b);
    mobileButtons.push({el:b,id:d.id});
  });
}

var state="title";
var cam={x:0}; // camera world X offset
var player={x:60,y:GROUND_Y,vx:0,vy:0,onGround:true,
  coyoteTimer:0,jumpBufferTimer:0,
  dashTimer:0,dashCooldown:0,dashDir:1,
  invuln:0,lives:MAX_LIVES,
  animFrame:0,animTimer:0,facing:1};
var hazards=[];
var pickups=[];
var obstacles=[]; // ground rocks
var particles=[];
var dunesFar=[],dunesMid=[];
var sandSpecs=[];
var score=0,scoreTimer=0;
var bestScore=parseInt(localStorage.getItem("freqfx_best"))||0;
var gameTime=0,spawnTimer=0,scrollSpeed=BASE_SCROLL;
var titleBlink=0,lastTime=0,shakeTimer=0;
var shimmerOffset=0;

// Held keys for continuous movement
var held={left:false,right:false,jump:false,dash:false};

// === INIT ===
function initWorld(){
  dunesFar=[];dunesMid=[];sandSpecs=[];obstacles=[];
  for(var i=0;i<12;i++){
    dunesFar.push({x:i*40,h:8+Math.random()*12,w:30+Math.random()*20});
    dunesMid.push({x:i*35,h:6+Math.random()*10,w:25+Math.random()*20});
  }
  for(var j=0;j<30;j++){
    sandSpecs.push({x:Math.random()*W*2,y:GROUND_Y+2+Math.random()*25});
  }
}

function resetGame(){
  player.x=60;player.y=GROUND_Y;player.vx=0;player.vy=0;
  player.onGround=true;player.coyoteTimer=0;player.jumpBufferTimer=0;
  player.dashTimer=0;player.dashCooldown=0;player.invuln=0;
  player.lives=MAX_LIVES;player.animFrame=0;player.animTimer=0;player.facing=1;
  cam.x=0;
  hazards=[];pickups=[];obstacles=[];particles=[];
  score=0;scoreTimer=0;gameTime=0;spawnTimer=0;scrollSpeed=BASE_SCROLL;shakeTimer=0;
  initWorld();
  // Pre-place some obstacles
  for(var i=0;i<5;i++){
    obstacles.push({x:200+i*80+Math.random()*40,w:10+Math.floor(Math.random()*6),h:8+Math.floor(Math.random()*6)});
  }
}

// === SPAWNING ===
function worldRight(){ return cam.x+W+40; }

function spawnHazard(){
  var wx=worldRight()+Math.random()*60;
  var flying=Math.random()>0.4;
  var hy=flying? GROUND_Y-20-Math.random()*30 : GROUND_Y;
  hazards.push({x:wx,y:hy,w:12,h:12,flash:0,flying:flying});
}

function spawnPickup(){
  var wx=worldRight()+Math.random()*60;
  var py=GROUND_Y-12-Math.random()*30;
  pickups.push({x:wx,y:py,w:8,h:8,bob:Math.random()*6.28});
}

function spawnObstacle(){
  var wx=worldRight()+Math.random()*40;
  // check no overlap with recent obstacles
  for(var i=0;i<obstacles.length;i++){
    if(Math.abs(obstacles[i].x-wx)<30) return;
  }
  obstacles.push({x:wx,w:10+Math.floor(Math.random()*6),h:8+Math.floor(Math.random()*8)});
}

function spawnParticles(x,y,color,count){
  for(var i=0;i<count;i++){
    particles.push({x:x,y:y,vx:(Math.random()-0.5)*80,vy:-Math.random()*60,life:0.3+Math.random()*0.3,color:color,size:1+Math.floor(Math.random()*2)});
  }
}

function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;
}

// === INPUT ===
var keys={};

document.addEventListener("keydown",function(e){
  if(keys[e.code]) {e.preventDefault();return;} // ignore repeats
  keys[e.code]=true;
  if(state==="title"){
    if(e.code==="Enter"||e.code==="Space"){resetGame();state="playing";}
    if(e.code==="KeyH") state="howto";
  } else if(state==="howto"){
    state="title";
  } else if(state==="playing"){
    if(e.code==="ArrowLeft"||e.code==="KeyA") held.left=true;
    if(e.code==="ArrowRight"||e.code==="KeyD") held.right=true;
    if(e.code==="ArrowUp"||e.code==="KeyW"||e.code==="Space"){held.jump=true;player.jumpBufferTimer=JUMP_BUFFER_MS;}
    if(e.code==="ShiftLeft"||e.code==="ShiftRight") held.dash=true;
    if(e.code==="Enter") state="paused";
  } else if(state==="paused"){
    if(e.code==="Enter") state="playing";
  } else if(state==="gameover"){
    if(e.code==="Enter"||e.code==="Space"){resetGame();state="playing";}
  }
  if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code)!==-1) e.preventDefault();
});

document.addEventListener("keyup",function(e){
  keys[e.code]=false;
  if(e.code==="ArrowLeft"||e.code==="KeyA") held.left=false;
  if(e.code==="ArrowRight"||e.code==="KeyD") held.right=false;
  if(e.code==="ArrowUp"||e.code==="KeyW"||e.code==="Space") held.jump=false;
  if(e.code==="ShiftLeft"||e.code==="ShiftRight") held.dash=false;
});

// Touch for title/menu
canvas.addEventListener("touchstart",function(e){
  e.preventDefault();
  var t=e.touches[0],rect=canvas.getBoundingClientRect();
  var sy=(t.clientY-rect.top)/rect.height*H;
  if(state==="title"){
    if(sy>85&&sy<105){resetGame();state="playing";}
    else if(sy>108&&sy<128) state="howto";
  } else if(state==="howto") state="title";
  else if(state==="paused") state="playing";
  else if(state==="gameover"){resetGame();state="playing";}
},{passive:false});

// Mobile button events
if(isMobile){
  mobileButtons.forEach(function(mb){
    mb.el.addEventListener("touchstart",function(e){
      e.preventDefault();e.stopPropagation();
      if(state!=="playing") return;
      if(mb.id==="ml") held.left=true;
      if(mb.id==="mr") held.right=true;
      if(mb.id==="mj"){held.jump=true;player.jumpBufferTimer=JUMP_BUFFER_MS;}
      if(mb.id==="md") held.dash=true;
    },{passive:false});
    mb.el.addEventListener("touchend",function(e){
      e.preventDefault();e.stopPropagation();
      if(mb.id==="ml") held.left=false;
      if(mb.id==="mr") held.right=false;
      if(mb.id==="mj") held.jump=false;
      if(mb.id==="md") held.dash=false;
    },{passive:false});
    mb.el.addEventListener("touchcancel",function(e){
      if(mb.id==="ml") held.left=false;
      if(mb.id==="mr") held.right=false;
      if(mb.id==="mj") held.jump=false;
      if(mb.id==="md") held.dash=false;
    });
  });
}

// === UPDATE ===
function update(dt){
  if(state!=="playing"){titleBlink+=dt;return;}

  gameTime+=dt;
  scrollSpeed=Math.min(BASE_SCROLL+gameTime*SCROLL_RAMP,MAX_SCROLL);
  shimmerOffset+=dt;

  // Score
  scoreTimer+=dt;
  if(scoreTimer>=1){scoreTimer-=1;score++;}

  // Timers
  if(player.dashTimer>0) player.dashTimer=Math.max(0,player.dashTimer-dt);
  if(player.dashCooldown>0) player.dashCooldown=Math.max(0,player.dashCooldown-dt);
  if(player.invuln>0) player.invuln=Math.max(0,player.invuln-dt);
  if(shakeTimer>0) shakeTimer=Math.max(0,shakeTimer-dt);
  if(player.jumpBufferTimer>0) player.jumpBufferTimer=Math.max(0,player.jumpBufferTimer-dt*1000);
  if(player.coyoteTimer>0) player.coyoteTimer=Math.max(0,player.coyoteTimer-dt*1000);

  // Dash activation
  if(held.dash&&player.dashTimer<=0&&player.dashCooldown<=0){
    player.dashTimer=DASH_DURATION;
    player.dashCooldown=DASH_COOLDOWN;
    player.dashDir=player.facing;
    spawnParticles(player.x,player.y-8,C_DASH_READY,6);
  }

  // Horizontal movement
  var isDashing=player.dashTimer>0;
  if(isDashing){
    player.vx=DASH_SPEED*player.dashDir;
  } else {
    if(held.left){player.vx=Math.max(player.vx-MOVE_ACCEL*dt,-MAX_RUN);player.facing=-1;}
    else if(held.right){player.vx=Math.min(player.vx+MOVE_ACCEL*dt,MAX_RUN);player.facing=1;}
    else {
      // friction
      if(player.vx>0) player.vx=Math.max(0,player.vx-MOVE_DECEL*dt);
      else if(player.vx<0) player.vx=Math.min(0,player.vx+MOVE_DECEL*dt);
    }
  }

  // Auto-scroll: world moves right, player stays relatively in view
  var autoScroll=scrollSpeed*dt;
  cam.x+=autoScroll;

  // Apply velocity
  player.x+=player.vx*dt;

  // Clamp player to camera bounds (can go slightly left but not off screen)
  var minX=cam.x+16;
  var maxX=cam.x+W-16;
  if(player.x<minX) player.x=minX;
  if(player.x>maxX) player.x=maxX;

  // Gravity
  if(!player.onGround){
    player.vy+=GRAVITY*dt;
  }
  player.y+=player.vy*dt;

  // Ground collision
  var groundLevel=GROUND_Y;
  // Check obstacle collision (standing on top)
  var onObstacle=false;
  for(var oi=0;oi<obstacles.length;oi++){
    var ob=obstacles[oi];
    var obTop=GROUND_Y-ob.h;
    // can land on top
    if(player.vy>=0 && player.x>ob.x-2 && player.x<ob.x+ob.w+2){
      if(player.y>=obTop && player.y-player.vy*dt<=obTop+4){
        groundLevel=obTop;
        onObstacle=true;
        break;
      }
    }
    // side collision (push player up if running into it)
    var px1=player.x-PLAYER_W/2, px2=player.x+PLAYER_W/2;
    var py1=player.y-PLAYER_H, py2=player.y;
    if(rectsOverlap(px1,py1,PLAYER_W,PLAYER_H,ob.x,obTop,ob.w,ob.h)){
      if(!onObstacle){
        // push out horizontally
        if(player.vx>0) player.x=ob.x-PLAYER_W/2-1;
        else if(player.vx<0) player.x=ob.x+ob.w+PLAYER_W/2+1;
      }
    }
  }

  if(player.y>=groundLevel){
    player.y=groundLevel;
    player.vy=0;
    if(!player.onGround) player.coyoteTimer=COYOTE_MS;
    player.onGround=true;
  } else {
    if(player.onGround && player.vy>=0) player.coyoteTimer=COYOTE_MS;
    player.onGround=false;
  }

  // Jump (with coyote time + buffer)
  var canJump=player.onGround||player.coyoteTimer>0;
  if(player.jumpBufferTimer>0&&canJump){
    player.vy=JUMP_VEL;
    player.onGround=false;
    player.coyoteTimer=0;
    player.jumpBufferTimer=0;
    spawnParticles(player.x,player.y,"#ddaa66",4);
  }

  // Variable jump height: release early = cut velocity
  if(!held.jump&&player.vy<JUMP_VEL*0.4){
    player.vy=JUMP_VEL*0.4;
  }

  // Animation
  if(!player.onGround){
    player.animFrame=3; // jump frame
  } else if(Math.abs(player.vx)>10){
    player.animTimer+=dt;
    if(player.animTimer>0.12){player.animTimer=0;player.animFrame=(player.animFrame+1)%3;}
  } else {
    player.animFrame=0;player.animTimer=0;
  }

  // Spawning
  spawnTimer-=dt;
  if(spawnTimer<=0){
    spawnTimer=Math.max(SPAWN_BASE-gameTime*SPAWN_RAMP,SPAWN_MIN);
    spawnHazard();
    if(gameTime>20&&Math.random()<0.3) spawnHazard();
    if(Math.random()<PICKUP_CHANCE) spawnPickup();
    if(Math.random()<0.5) spawnObstacle();
  }

  // Hazard update + collision
  var isInvuln=player.invuln>0||isDashing;
  var pr={x:player.x-PLAYER_W/2,y:player.y-PLAYER_H,w:PLAYER_W,h:PLAYER_H};

  for(var i=hazards.length-1;i>=0;i--){
    var hz=hazards[i];
    if(!hz.flying) hz.x-=scrollSpeed*0.3*dt; // ground hazards drift slightly
    hz.flash+=dt;
    // flying hazards move toward player slightly
    if(hz.flying) hz.x-=scrollSpeed*0.8*dt;
    if(hz.x<cam.x-40){hazards.splice(i,1);continue;}
    var hx=hz.x-hz.w/2,hy=hz.y-hz.h;
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,hx,hy,hz.w,hz.h)){
      player.lives--;
      player.invuln=INVULN_TIME;
      shakeTimer=0.3;
      spawnParticles(hz.x,hz.y-6,C_HAZARD,10);
      hazards.splice(i,1);
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Pickup update
  for(var j=pickups.length-1;j>=0;j--){
    var pk=pickups[j];
    pk.bob+=dt*4;
    if(pk.x<cam.x-40){pickups.splice(j,1);continue;}
    var pkY=pk.y+Math.sin(pk.bob)*3;
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,pk.x-pk.w/2,pkY-pk.h/2,pk.w,pk.h)){
      score+=10;
      spawnParticles(pk.x,pkY,C_PICKUP,8);
      pickups.splice(j,1);
    }
  }

  // Cleanup obstacles behind camera
  for(var k=obstacles.length-1;k>=0;k--){
    if(obstacles[k].x+obstacles[k].w<cam.x-20) obstacles.splice(k,1);
  }

  // Particles
  for(var m=particles.length-1;m>=0;m--){
    var pt=particles[m];
    pt.x+=pt.vx*dt;pt.y+=pt.vy*dt;pt.vy+=200*dt;pt.life-=dt;
    if(pt.life<=0) particles.splice(m,1);
  }

  // Scroll sand specs
  for(var s=0;s<sandSpecs.length;s++){
    sandSpecs[s].x-=scrollSpeed*0.8*dt;
    if(sandSpecs[s].x<cam.x-20){
      sandSpecs[s].x=cam.x+W+Math.random()*40;
      sandSpecs[s].y=GROUND_Y+2+Math.random()*25;
    }
  }
}

function gameOver(){
  state="gameover";
  if(score>bestScore){bestScore=score;localStorage.setItem("freqfx_best",bestScore.toString());}
  try{window.parent.postMessage({type:"FREQFX_GAME_OVER",score:score,best:bestScore},"*");}catch(e){}
}

// === DRAW ===
function F(v){return Math.floor(v);}

function drawRect(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(F(x),F(y),w,h);}
function drawText(t,x,y,c,a){ctx.fillStyle=c||C_TEXT;ctx.textAlign=a||"left";ctx.fillText(t,F(x),F(y));}

// World-to-screen
function wx(worldX){return worldX-cam.x;}

function drawSkyAndSun(){
  // Sky gradient (manual pixel bands)
  var bands=16;
  for(var i=0;i<bands;i++){
    var t=i/bands;
    var r=F(26+t*178),g=F(5+t*97),b=F(51-t*17);
    drawRect(0,i*(GROUND_Y/bands),W,Math.ceil(GROUND_Y/bands),"rgb("+r+","+g+","+b+")");
  }
  // Sun
  var sunX=W-40,sunY=25;
  ctx.fillStyle=C_SUN_GLOW;
  ctx.beginPath();ctx.arc(sunX,sunY,16,0,6.29);ctx.fill();
  ctx.fillStyle=C_SUN;
  ctx.beginPath();ctx.arc(sunX,sunY,8,0,6.29);ctx.fill();
  ctx.fillStyle="#ffee88";
  ctx.beginPath();ctx.arc(sunX,sunY,5,0,6.29);ctx.fill();
}

function drawDunes(){
  // Far dunes (slow parallax)
  ctx.fillStyle=C_DUNE_FAR;
  for(var i=0;i<dunesFar.length;i++){
    var d=dunesFar[i];
    var sx=((d.x-cam.x*0.15)%W+W)%W-20;
    drawRect(sx,GROUND_Y-d.h-8,d.w,d.h+8,C_DUNE_FAR);
  }
  // Mid dunes
  ctx.fillStyle=C_DUNE_MID;
  for(var j=0;j<dunesMid.length;j++){
    var dm=dunesMid[j];
    var smx=((dm.x-cam.x*0.3)%W+W)%W-20;
    drawRect(smx,GROUND_Y-dm.h-3,dm.w,dm.h+3,C_DUNE_MID);
  }
  // Near dune strip
  drawRect(0,GROUND_Y-4,W,4,C_DUNE_NEAR);
}

function drawGround(){
  // Main ground
  drawRect(0,GROUND_Y,W,H-GROUND_Y,C_GROUND);
  drawRect(0,GROUND_Y,W,2,C_GROUND_LINE);
  // Dark layer
  drawRect(0,GROUND_Y+10,W,H-GROUND_Y-10,C_GROUND_DARK);
  // Sand specks
  for(var i=0;i<sandSpecs.length;i++){
    var s=sandSpecs[i];
    var sx=wx(s.x);
    if(sx>-2&&sx<W+2) drawRect(sx,s.y,1,1,C_SAND_SPEC);
  }
  // Heat shimmer (subtle scanline wobble near ground)
  if(Math.sin(shimmerOffset*2)>0.5){
    ctx.globalAlpha=0.06;
    drawRect(0,GROUND_Y-8,W,4,"#fff");
    ctx.globalAlpha=1;
  }
}

function drawObstacles(){
  for(var i=0;i<obstacles.length;i++){
    var ob=obstacles[i];
    var sx=wx(ob.x);
    if(sx<-20||sx>W+20) continue;
    var top=GROUND_Y-ob.h;
    // Rock/crate shape
    drawRect(sx,top,ob.w,ob.h,"#996644");
    drawRect(sx+1,top+1,ob.w-2,ob.h-2,"#887755");
    drawRect(sx+1,top+1,ob.w-2,2,"#aa8866"); // highlight
    drawRect(sx,top,1,ob.h,"#776644"); // left shadow
  }
}

// Robot sprite (procedural pixel art)
function drawRobot(){
  var sx=wx(player.x),sy=player.y;
  if(player.invuln>0&&F(player.invuln*10)%2) return;

  var f=player.facing;
  var frame=player.animFrame;
  var isDashing=player.dashTimer>0;
  var body=isDashing?C_DASH_READY:C_ROBOT_BODY;
  var dark=isDashing?"#22aa88":C_ROBOT_DARK;
  var light=isDashing?"#66ddbb":C_ROBOT_LIGHT;
  var visor=C_VISOR;

  // Feet offset for run animation
  var lfoot=0,rfoot=0;
  if(frame===1){lfoot=-2;rfoot=1;}
  else if(frame===2){lfoot=1;rfoot=-2;}
  if(frame===3){lfoot=0;rfoot=0;} // jump: legs together, tucked

  var bx=F(sx),by=F(sy);

  // === HELMET (top) ===
  drawRect(bx-5,by-16,10,6,dark);       // helmet outer
  drawRect(bx-4,by-15,8,4,body);        // helmet inner
  drawRect(bx-4,by-16,8,1,"#aabbcc");   // helmet top shine

  // === VISOR ===
  if(f===1){
    drawRect(bx,by-14,3,3,visor);
    drawRect(bx+1,by-14,1,1,C_VISOR_HI); // highlight
  } else {
    drawRect(bx-3,by-14,3,3,visor);
    drawRect(bx-2,by-14,1,1,C_VISOR_HI);
  }

  // === BODY (torso) ===
  drawRect(bx-5,by-10,10,7,dark);       // body outer
  drawRect(bx-4,by-9,8,5,body);         // body main
  drawRect(bx-3,by-8,6,3,light);        // chest plate highlight

  // === ARMS ===
  if(frame===3){
    // Jump: arms up
    drawRect(bx-7,by-13,2,5,dark);
    drawRect(bx+5,by-13,2,5,dark);
  } else {
    var armOff=frame===1?-1:frame===2?1:0;
    drawRect(bx-7,by-9+armOff,2,5,dark);
    drawRect(bx+5,by-9-armOff,2,5,dark);
  }

  // === LEGS ===
  if(frame===3){
    // Jump: legs tucked
    drawRect(bx-4,by-3,3,2,dark);
    drawRect(bx+1,by-3,3,2,dark);
  } else {
    drawRect(bx-4,by-3+lfoot,3,3+Math.abs(lfoot),dark);
    drawRect(bx+1,by-3+rfoot,3,3+Math.abs(rfoot),dark);
    // Feet
    drawRect(bx-5,by+lfoot,4,1,"#555");
    drawRect(bx+1,by+rfoot,4,1,"#555");
  }

  // Dash trail
  if(isDashing){
    ctx.globalAlpha=0.4;
    drawRect(bx-f*8-4,by-10,8,7,C_DASH_READY);
    ctx.globalAlpha=0.2;
    drawRect(bx-f*16-3,by-8,6,4,C_DASH_READY);
    ctx.globalAlpha=1;
  }
}

function drawHazards(){
  for(var i=0;i<hazards.length;i++){
    var hz=hazards[i];
    var sx=wx(hz.x),sy=hz.y;
    if(sx<-20||sx>W+20) continue;
    var fl=Math.sin(hz.flash*12)>0;

    if(hz.flying){
      // Spark drone: small hovering device
      drawRect(sx-7,sy-12,14,8,fl?"#553333":"#442222");
      drawRect(sx-6,sy-11,12,6,"#663333");
      // Eye
      drawRect(sx-2,sy-10,4,3,fl?C_SPARK:C_HAZARD);
      // Spark underneath
      if(fl){
        drawRect(sx-1,sy-4,2,4,C_SPARK);
        drawRect(sx,sy-2,1,3,"#fff");
      }
      // Propeller dots
      var pp=Math.sin(hz.flash*20)*3;
      drawRect(sx-5+pp,sy-14,2,2,"#888");
      drawRect(sx+3-pp,sy-14,2,2,"#888");
    } else {
      // Ground spark gate: two posts with electricity
      drawRect(sx-6,sy-14,3,14,"#664444");
      drawRect(sx+3,sy-14,3,14,"#664444");
      // Spark between posts
      if(fl){
        for(var s=0;s<4;s++){
          var sy2=sy-12+s*3;
          var jitter=F((Math.random()-0.5)*4);
          drawRect(sx-3+jitter,sy2,6,1,C_SPARK);
        }
      }
      drawRect(sx-5,sy-14,2,2,C_HAZARD);
      drawRect(sx+4,sy-14,2,2,C_HAZARD);
    }
  }
}

function drawPickups(){
  for(var i=0;i<pickups.length;i++){
    var pk=pickups[i];
    var sx=wx(pk.x),sy=pk.y+Math.sin(pk.bob)*3;
    if(sx<-20||sx>W+20) continue;
    // Energy cell: glowing hexagonal-ish shape
    drawRect(sx-4,sy-5,8,10,C_PICKUP);
    drawRect(sx-3,sy-4,6,8,"#22ccaa");
    drawRect(sx-2,sy-3,4,6,C_PICKUP_GLOW);
    // Glow
    ctx.globalAlpha=0.3;
    drawRect(sx-6,sy-7,12,14,C_PICKUP);
    ctx.globalAlpha=1;
    // Top/bottom connectors
    drawRect(sx-1,sy-7,2,2,"#aaa");
    drawRect(sx-1,sy+5,2,2,"#aaa");
  }
}

function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];
    ctx.globalAlpha=Math.min(1,p.life*3);
    drawRect(wx(p.x),p.y,p.size,p.size,p.color);
  }
  ctx.globalAlpha=1;
}

function drawHUD(){
  drawRect(0,0,W,16,C_HUD_BG);
  ctx.font="5px monospace";
  // Hearts
  for(var i=0;i<MAX_LIVES;i++){
    var hx=4+i*14,c=i<player.lives?C_HEART:"#442222";
    drawRect(hx,3,3,3,c);drawRect(hx+4,3,3,3,c);
    drawRect(hx,6,7,4,c);drawRect(hx+1,10,5,2,c);drawRect(hx+2,12,3,1,c);
  }
  drawText("SCORE:"+score,W/2,12,C_TEXT,"center");
  drawText("HI:"+bestScore,W-4,12,C_TEXT_DIM,"right");

  // Dash bar
  var dashReady=player.dashCooldown<=0&&player.dashTimer<=0;
  drawRect(W-32,H-12,28,8,"#221100");
  var pct=dashReady?1:1-(player.dashCooldown/DASH_COOLDOWN);
  drawRect(W-31,H-11,F(26*pct),6,dashReady?C_DASH_READY:C_DASH_COOL);
  ctx.font="4px monospace";
  drawText("DASH",W-31,H-14,dashReady?C_DASH_READY:C_DASH_COOL,"left");
}

function drawTitle(){
  // Desert sky bg
  drawSkyAndSun();
  drawDunes();
  drawRect(0,GROUND_Y,W,H-GROUND_Y,C_GROUND);

  ctx.font="10px monospace";
  drawText("FREQ-FX",W/2,38,C_TEXT,"center");
  ctx.font="7px monospace";
  drawText("PCB RUNNER",W/2,52,C_TEXT_DIM,"center");
  ctx.font="5px monospace";
  drawText("Dezert Audio",W/2,66,"#cc9955","center");

  var blink=Math.sin(titleBlink*3)>0;
  ctx.font="6px monospace";
  drawText("> START",W/2,96,blink?C_TEXT:C_TEXT_DIM,"center");
  drawText("HOW TO PLAY",W/2,116,C_TEXT_DIM,"center");
  drawText("NOTIFY ME",W/2,136,"#ffaa44","center");

  ctx.font="5px monospace";
  drawText("BEST: "+bestScore,W/2,154,C_TEXT_DIM,"center");
  drawText(isMobile?"TAP START":"ENTER / SPACE",W/2,80,C_TEXT_DIM,"center");
}

function drawHowTo(){
  drawSkyAndSun();
  drawRect(0,GROUND_Y,W,H-GROUND_Y,C_GROUND);

  ctx.font="7px monospace";
  drawText("HOW TO PLAY",W/2,18,C_TEXT,"center");
  ctx.font="5px monospace";
  var lines=[
    "You are a ROBOT in the desert.",
    "Dodge SPARK DRONES & GATES!",
    "Collect ENERGY CELLS +10pts.",
    "",
    "DESKTOP:",
    " LEFT/RIGHT or A/D = run",
    " UP/W/SPACE = jump",
    " SHIFT = dash (invincible)",
    " ENTER = pause",
    "",
    "MOBILE:",
    " On-screen buttons for move,",
    " jump, and dash",
    "",
    "Speed increases over time."
  ];
  for(var i=0;i<lines.length;i++) drawText(lines[i],14,32+i*8,C_TEXT_DIM,"left");
  var blink=Math.sin(titleBlink*3)>0;
  drawText(isMobile?"TAP TO BACK":"ANY KEY = BACK",W/2,156,blink?C_TEXT:C_TEXT_DIM,"center");
}

function drawPaused(){
  ctx.fillStyle="rgba(0,0,0,0.6)";ctx.fillRect(0,0,W,H);
  ctx.font="8px monospace";
  drawText("PAUSED",W/2,75,C_TEXT,"center");
  ctx.font="5px monospace";
  drawText(isMobile?"TAP TO RESUME":"ENTER = RESUME",W/2,90,C_TEXT_DIM,"center");
}

function drawGameOver(){
  ctx.fillStyle="rgba(0,0,0,0.7)";ctx.fillRect(0,0,W,H);
  ctx.font="8px monospace";
  drawText("GAME OVER",W/2,55,C_HAZARD,"center");
  ctx.font="6px monospace";
  drawText("SCORE: "+score,W/2,75,C_TEXT,"center");
  drawText(score>=bestScore?"NEW BEST!":"BEST: "+bestScore,W/2,90,score>=bestScore?"#ffcc00":C_TEXT_DIM,"center");
  ctx.font="5px monospace";
  var blink=Math.sin(titleBlink*3)>0;
  drawText(isMobile?"TAP TO RETRY":"ENTER / SPACE",W/2,110,blink?C_TEXT:C_TEXT_DIM,"center");
}

function draw(){
  ctx.save();
  if(shakeTimer>0) ctx.translate(F((Math.random()-0.5)*4),F((Math.random()-0.5)*4));
  ctx.font="5px monospace";

  if(state==="title"){drawTitle();}
  else if(state==="howto"){drawHowTo();}
  else {
    drawSkyAndSun();
    drawDunes();
    drawGround();
    drawObstacles();
    drawPickups();
    drawHazards();
    drawRobot();
    drawParticles();
    drawHUD();
    if(state==="paused") drawPaused();
    if(state==="gameover") drawGameOver();
  }
  ctx.restore();
}

// === RESIZE ===
function resize(){
  var scale=Math.min(window.innerWidth/W,window.innerHeight/H);
  canvas.style.width=F(W*scale)+"px";
  canvas.style.height=F(H*scale)+"px";
}
window.addEventListener("resize",resize);
resize();

// === LOOP ===
function loop(ts){
  requestAnimationFrame(loop);
  if(!lastTime) lastTime=ts;
  var dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;
  update(dt);draw();
}

initWorld();
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
